<!DOCTYPE html><html lang="en"> 
<!-- Mirrored from kamranahmed.info/posts/rabbitmq-at-tajawal by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 30 Sep 2025 03:09:39 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="../favicon.svg"><title>RabbitMQ at Tajawal: A Case Study</title><meta name="description" content="Learn how we migrated a legacy system to a modern, scalable, and reliable messaging system using RabbitMQ."><link rel="preconnect" href="https://www.google-analytics.com/"><link rel="stylesheet" href="../_astro/background-less.BKeRS0Lf.css">
<style>@keyframes fade-appear{0%{border-radius:.5rem;--tw-bg-opacity: 1;background-color:rgb(55 65 81 / var(--tw-bg-opacity));--tw-text-opacity: 1;color:rgb(254 249 195 / var(--tw-text-opacity))}}@keyframes slide-fade-up-in{0%{opacity:0;transform:translateY(.5rem)}to{opacity:1;transform:translateY(0)}}[data-rmiz-modal-content]{--tw-bg-opacity: 1;background-color:rgb(24 24 27 / var(--tw-bg-opacity));--tw-text-opacity: 1;color:rgb(243 244 246 / var(--tw-text-opacity))}::-moz-selection{--tw-bg-opacity: 1;background-color:rgb(250 204 21 / var(--tw-bg-opacity));--tw-text-opacity: 1;color:rgb(113 63 18 / var(--tw-text-opacity))}::selection{--tw-bg-opacity: 1;background-color:rgb(250 204 21 / var(--tw-bg-opacity));--tw-text-opacity: 1;color:rgb(113 63 18 / var(--tw-text-opacity))}
</style><script type="module">window.fireEvent=e=>{const{action:n,category:t,label:a,value:i}=e;if(!window.gtag){console.warn("Missing GTAG - Analytics disabled");return}window.gtag("event",n,{event_category:t,event_label:a,value:i})};
</script>
<script type="module" src="../_astro/page.DFwqf4PB.js"></script></head> <body class="bg-zinc-900 text-zinc-400"> <div class="mx-auto max-w-[750px] px-4 pb-20 pt-6 text-lg sm:px-12 md:px-16"> <div class="flex items-center justify-between gap-5 rounded-3xl border border-zinc-700/40 bg-zinc-800 px-5 text-base sm:px-6"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t.html),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="ZursTB" prefix="r0" component-url="/_astro/MobileNav.DoOW3-tu.js" component-export="MobileNav" renderer-url="/_astro/client.BStqXOaq.js" props="{}" ssr="" client="load" opts="{&quot;name&quot;:&quot;MobileNav&quot;,&quot;value&quot;:true}" await-children=""><div class="relative block sm:hidden"><button type="button" class="flex items-center py-3 text-sm transition-colors hover:text-zinc-300 sm:hidden sm:text-base"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg><span> </span></button></div><!--astro:end--></astro-island> <div class="hidden items-center gap-6 sm:flex"> <a class="relative flex items-center gap-2 py-3 pr-1 text-sm transition-colors hover:text-zinc-300 sm:text-base" href="../index.html" target="_self" data-astro-prefetch="load"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"></path><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>Home</a> <a class="relative flex items-center gap-2 py-3 pr-1 text-sm transition-colors hover:text-zinc-300 sm:text-base" href="../work.html" target="_self" data-astro-prefetch="load"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-briefcase"><path d="M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path><rect width="20" height="14" x="2" y="6" rx="2"></rect></svg>Work</a> <a class="relative flex items-center gap-2 py-3 pr-1 text-sm transition-colors hover:text-zinc-300 sm:text-base" href="../projects.html" target="_self" data-astro-prefetch="load"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"></path></svg>Projects</a> <a class="relative flex items-center gap-2 py-3 pr-1 text-sm transition-colors hover:text-zinc-300 sm:text-base" href="../posts.html" target="_self" data-astro-prefetch="load"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-text"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"></path><path d="M8 11h8"></path><path d="M8 7h6"></path></svg>Posts<span class="absolute -bottom-px left-0 right-0 h-px bg-gradient-to-r from-zinc-400/0 via-zinc-400/40 to-zinc-400/0"></span></a> </div> <a class="relative flex items-center gap-2 py-3 pr-1 text-sm transition-colors hover:text-zinc-300 sm:text-base" href="../cdn-cgi/l/email-protection.html#f89399958a99969990959d9cd68b9db89f95999194d69b9795" target="_self" data-astro-prefetch="load"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></svg>Say Hi</a> </div> <div>  <div class="container"> <div class="mb-6 mt-12"> <h1 class="mb-2 text-balance text-4xl font-bold leading-tight text-neutral-100"> RabbitMQ at Tajawal: A Case Study </h1> <p class="text-base text-neutral-400"> September 9, 2018 </p> </div> <div class="prose prose-img:bg-white prose-img:px-2 prose-img:py-2 prose-img:rounded-md prose-lg prose-quoteless prose-blockquote:text-zinc-300 prose-blockquote:border-l-8 prose-blockquote:border-l-current prose-blockquote:font-normal prose-neutral-300 prose-h3:text-neutral-100 prose-h4:text-neutral-100 prose-h2:text-neutral-100 prose-code:font-normal prose-code:before:hidden prose-code:after:hidden prose-a:text-blue-300 prose-code:text-yellow-200 prose-strong:text-white prose-h1:text-balance prose-h2:text-balance prose-h3:text-balance prose-h4:text-balance prose-h5:text-balance leading-relaxed text-neutral-300"> <p>We have a suite of products at tajawal, made out of ~80 services both internal and external. We have been using RabbitMQ extensively and it has worked pretty well for us over the past year and a half. This article is going to be a brief overview of how we migrated our cronjobs based system to use RabbitMQ and to give you an idea about how all of it is set up.</p>
<h2 id="some-statistics">Some Statistics</h2>
<p>At the time of writing this article, RabbitMQ has been live for around a year and a half. There are 80 virtual hosts, 160 exchanges, and 192 queues. The average message rate is around 250–300 messages per second depending upon the time of the day and the count and nature of bookings coming in.</p>
<p><img src="rabbitmq-stats.png" alt="RabbitMQ at Tajawal"></p>
<h2 id="before-rabbitmq">Before RabbitMQ</h2>
<p>Before integrating RabbitMQ, everything used to be handled through cronjobs and HTTP requests. Each of the products used to have their own set of cronjobs that were handling the tasks related to that service.</p>
<p><img src="before-rabbitmq.png" alt="Before RabbitMQ"></p>
<p>To give you an idea, for example, while booking a flight as soon as the user used to checkout, we would create a booking entry in the database with the status set to pending. Then a cronjob responsible for handling pending status would pick it up, do the necessary processing and change the status for some next cronjob, then the next cronjob would pick it up, perform its processing and change the status for the next cronjob and so on. This chain of cronjobs would continue till the order is fulfilled and the ticket is sent to the customer. This wasn’t really the best setup but it was intentionally made it that way so to keep it simple and allow us to easily replace this later on with any queuing mechanism if required. Here is the example image to give you the basic idea of how each of the products was set up.</p>
<p><img src="flow-before-rabbitmq.png" alt="Flow Before RabbitMQ"></p>
<h2 id="the-problems">The Problems</h2>
<p>The mechanism worked pretty well for some time. But as the systems kept growing, HTTP calls and the cronjobs started to show age. Most of the common issues encountered were:</p>
<ul>
<li>Higher resolution times i.e. the tasks were not picked up immediately and the crons could have been running dry when there is no data to process</li>
<li>Crons are per-machine tasks i.e. if you are going to run them on multiple servers, you are going to need some sort of locking mechanism which in return is going to need maintenance, for example cleaning up the stale locks from the abnormally failed crons etc. So we ended up having a lot of boilerplate code to manage even small tasks.</li>
<li>Error Handling i.e. in the cases when the command fails during the process or there are some items that are never picked up</li>
<li>No good way to monitor i.e. where and how the things are going or to track the load at the system at any point of time</li>
<li>System level task rather than an application level task. Developers should not care where the application is run. With crons being a system level task, it was difficult for developers to debug or to test</li>
<li>Difficult to debug. Have a look at this <a href="https://askubuntu.com/questions/23009/why-crontab-scripts-are-not-working">stackexchange thread</a>.</li>
</ul>
<h2 id="choosing-rabbitmq">Choosing RabbitMQ</h2>
<p>Keeping in view these issues, we started looking for the alternatives with at least the below listed items being in our wishlist</p>
<ul>
<li>Lower the resolution time</li>
<li>Developer friendly and powerful</li>
<li>Easy to test and monitor</li>
<li>Easy to scale without any boilerplate code</li>
<li>Easy to handle errors</li>
</ul>
<p>The idea was to make our systems easier to scale by converting mainly the state-flow and some other key functionalities to be handled through some queuing mechanism instead of the cronjobs.</p>
<p>We did some research and looked at the available alternatives. After comparisons and some thorough research, it came down to either using <a href="https://kafka.apache.org/">Apache Kafka</a> or to go with <a href="https://www.rabbitmq.com/">RabbitMQ</a> and we finally decided to go with RabbitMQ; mainly because of the reasons listed below –</p>
<ul>
<li>Easier management and monitoring because of the available HTTP API, command line tool, and the admin panel</li>
<li>Wide variety of available tools and plugins. There is a large number of tools and plugins available to extend what RabbitMQ does</li>
<li>Ability to write and extend the functionality using custom plugins</li>
<li>Better Developer experience</li>
<li>Flexible routing and multiple messaging protocols etc</li>
</ul>
<h2 id="using-rabbitmq">Using RabbitMQ</h2>
<p>Before I go and explain how RabbitMQ fits into our architecture, let me put below a rough diagram of how RabbitMQ works</p>
<p><img src="rabbitmq-architecture.png" alt="RabbitMQ"></p>
<p>Have a look at <a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html">this article</a> if you would like to understand the different parts shown in the diagram above.</p>
<p>In the next sections, I will discuss how we have put it all together to make it work for us. First of all, I will be discussing how we are defining the required structures, then we discuss how the publishers are set to dispatch the messages, after that we will be discussing how the consumers consume these messages and then I will end the article with the bigger picture of how all of it is put together.</p>
<h3 id="defining-virtual-hosts-exchanges-queues-policies-and-users">Defining Virtual Hosts, Exchanges, Queues, Policies and Users</h3>
<p>Before you start using RabbitMQ, you need to define all the key pieces i.e. vhosts, exchanges, queues, policies and users. There are multiple ways to define them</p>
<ul>
<li>Do it from the admin panel of RabbitMQ</li>
<li>Do it from the CLI</li>
<li>Use the <a href="https://cdn.rawgit.com/rabbitmq/rabbitmq-management/v3.7.7/priv/www/api/index.html">HTTP API</a> provided by RabbitMQ</li>
</ul>
<p>We wanted something flexible so we ended up using the API. We have an internal tool called ops-tool where we have defined all the vhosts, exchanges and queues in the form of a folder structure. Whenever the developers have to update the virtual hosts, users, exchanges, queues or policies, all they have to do is open that tool, modify or add to the folder structure and run the command and it will automatically do the necessary modifications using the API. Diagram below shows part of the directory structure that is turned into the vhosts, exchanges and queues.</p>
<p><img src="dir-structure.png" alt="RabbitMQ Directory Structure"></p>
<p>The command is idempotent; evaluates the difference and only applies the provided changes without affecting any existing structure. Plus, it is registered in the docker machines used by developers so that the changes are replicated on the developer machines as soon as they are made.</p>
<h3 id="standardizing-the-message-formats">Standardizing the Message Formats</h3>
<p>With the lots of applications and the messages coming from many different publishers, it was of the paramount importance that we standardize the message formats. In order to do that we created a standard package called Rabbit which helps the publishers connect to the broker and generate the standard messages to be sent. All the messages have to be defined in the form of classes in this package and messages must be dispatched by creating instances of these classes. Any application that wants to connect to RabbitMQ, it must have this package installed and the message formats defined.</p>
<p><img src="rabbit-sdk.png" alt="Rabbit SDK"></p>
<h3 id="consuming-the-messages">Consuming the Messages</h3>
<p>On the consumers side, we decided to split the commands from the actual projects and thus created associated cli applications for each of the products. For example, flight-api was divided into two applications i.e. flight-api and flight-api-cli, hotel-api divided into hotel-api and hotel-api-cli and so on.</p>
<p><img src="rabbit-before-after.png" alt="RabbitMQ Before and After"></p>
<p>CLI applications or consumers are just the simple commands that receive the messages and <a href="https://github.com/hollodotme/fast-cgi-client">dispatch async requests using FPM</a> to the relevant handler for that message.</p>
<h2 id="all-the-pieces-combined">All the Pieces Combined</h2>
<p>Here is the bigger picture of how all of it is put together</p>
<p><img src="after-rabbitmq.png" alt="RabbitMQ at Tajawal"></p>
<p>In the image above, publisher can be any product that wants to dispatch messages with the package Rabbit installed in it. To explain it with an example, in the case of bookings API the publisher is booking-api; whenever there is a checkout, it would get the booking details, populate them in the object of relevant message class found in the Rabbit package and dispatch it on the relevant channel. This message will automatically find the relevant exchange because of the configuration available in the message class which was used to dispatch the message. Broker will then route it to the relevant queue based on the type of exchange. After that, the consumer kicks in, which is normally the CLI application e.g. bookings-cli in this case. It will use the channel class found in the RabbitMQ to pull the message from the relevant queue and <a href="https://github.com/hollodotme/fast-cgi-client">dispatch it asynchronously using fpm-client</a> to an internal route in the CLI for it to be handled accordingly. The route handler will catch this fpm request, will then populate this message back into the object of the Message class in the Rabbit package and process it accordingly.</p> </div> </div>  </div> </div>  <script data-cfasync="false" src="../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-139582634-1"></script> <script>
    // @ts-nocheck
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-58155965-1');
</script> <script type="text/javascript">
  (function (C, A, L) {
    let p = function (a, ar) {
      a.q.push(ar);
    };
    let d = C.document;
    C.Cal =
      C.Cal ||
      function () {
        let cal = C.Cal;
        let ar = arguments;
        if (!cal.loaded) {
          cal.ns = {};
          cal.q = cal.q || [];
          d.head.appendChild(d.createElement('script')).src = A;
          cal.loaded = true;
        }
        if (ar[0] === L) {
          const api = function () {
            p(api, arguments);
          };
          const namespace = ar[1];
          api.q = api.q || [];
          typeof namespace === 'string'
            ? (cal.ns[namespace] = api) && p(api, ar)
            : p(cal, ar);
          return;
        }
        p(cal, ar);
      };
  })(window, '../../app.cal.com/embed/embed.js', 'init');
  Cal('init', { origin: 'https://cal.com' });

  Cal('ui', {
    styles: { branding: { brandColor: '#000000' } },
    hideEventTypeDetails: false,
    layout: 'month_view',
  });
</script> </body>
<!-- Mirrored from kamranahmed.info/posts/rabbitmq-at-tajawal by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 30 Sep 2025 03:09:41 GMT -->
</html>